$(function() {
    //lnb
    var header = {},
        $window = $(window),
        $html = $('html'),
        $header = $('#header'),
        lnb = header.lnb = {},
        $lnb = lnb.$element = $header.find('.lnb'),
        $lnbTabItem = lnb.$tabItem = $lnb.find('.tab_item'),
        $lnbNavItem = lnb.$navItem = $lnbTabItem.eq(0),
        $lnbTabContent = lnb.$tabContent = $lnb.find('.tab_content'),
        $lnbNavContent = lnb.$navContent = $lnbTabContent.eq(0),
        $lnbShow = lnb.$show = $lnb.find('.menu_show'),
        $lnbShowBtn = lnb.$showBtn = $lnbShow.find('.menu_button'),
        $lnbHide = lnb.$hide = $lnb.find('.menu_hide'),
        $lnbHideBtn = lnb.$hideBtn = $lnbHide.find('.menu_button'),
        $lnbDepthItem = lnb.$depthItem = $lnb.find('.depth_item'),
        $lnbMenu = lnb.$menu = $lnb.find('.menu'),
        $lnbDepth2FirstChild = lnb.$depth2FirstChild = $lnbMenu.find('.depth2 > :first-child'),
        $lnbSpy = lnb.$spy = $lnbMenu.find('.spy:last'),
        lnbHeight;

    $lnbSpy.parents('.depth_item').addClass('actived');

    $window.on('screen:wide.menu screen:web.menu', function(event) {
        window.mode = 'pc';
    });

    $window.on('screen:tablet.menu screen:phone.menu', function(event) {
        window.mode = 'mobile';
    });

    function refreshLnbHeight() {
        lnbHeight = $lnbMenu.removeClass('init').css('transition-property', 'none').outerHeight() || '';
        $lnbMenu.addClass('init').css('transition-property', '');
    }

    $lnbShowBtn.on('click.menu', function(event) {
        //클래스 토글
        $html.toggleClass('lnb_show');
    });

    $lnbHideBtn.on('click.menu', function(event) {
        //클래스 토글
        $html.removeClass('lnb_show');
    });

    $window.on('screen:wide.menu screen:web.menu', function(event) {
        $lnbTabItem.removeClass('active');
        $lnbNavItem.addClass('active');

        $lnbTabContent.removeClass('active')
        $lnbNavContent.addClass('active');
    });

    $lnbDepthItem.on('mouseover.menu focusin.menu', function(event) {
        if(mode === 'pc') {
            var $this = $(this),
                $depth1Item = ($this.hasClass('depth1_item')) ? $this : $this.parents('.depth1_item');

            if($lnbMenu.hasClass('pulldown')) {
                var maxHeight = 0;

                $lnbDepth2FirstChild.each(function(index, element) {
                    var $element = $(element),
                        outerHeight = $element.outerHeight() || 0;

                    //기존 값 보다 얻은 값이 초과일 때
                    if(outerHeight > maxHeight) {
                        maxHeight = outerHeight;
                    }
                });

                $lnbMenu.height(lnbHeight + maxHeight);
            }else if($lnbMenu.hasClass('eachdown')) {
                $lnbMenu.height(lnbHeight + ($depth1Item.find('.depth2 > :first-child').outerHeight() || ''));
            }

            $html.addClass('lnb_open');
            $lnbDepthItem.removeClass('active');
            $this.addClass('active').parents('li').addClass('active');
        }

        event.stopPropagation();
    }).on('click.menu', function(event) {
        if(mode === 'mobile') {
            var $this = $(this),
                $depthText = $this.children('.depth_text'),
                eventTarget = event.target;

            if($depthText.find(eventTarget).length || $depthText[0] === eventTarget) {
                if($this.hasClass('depth1_item')) {
                    if($this.hasClass('active')) {
                        $html.removeClass('lnb_open');
                    }else{
                        $html.addClass('lnb_open');
                    }
                }

                if($this.children('.depth').length) {
                    $this.toggleClass('active').siblings('.depth_item').removeClass('active');
                    event.preventDefault();
                }
            }
        }

        event.stopPropagation();
    }).each(function(index, element) {
        var $element = $(element);

        if($element.children('.depth').length) {
            $element.addClass('has');
        }
    });

    $lnbMenu.find('.depth1_item:last-child .depth2 .depth2_list .depth2_item:last-child .depth2_text').on('focusout', function(event) {
        if(mode === 'pc') {
            $lnbMenu.height('');
            $html.removeClass('lnb_open');
            $lnbDepthItem.removeClass('active');
        }
    });

    $lnbMenu.on('mouseleave.menu', function(event) {
        if(mode === 'pc') {
            $lnbMenu.height('');
            $html.removeClass('lnb_open');
            $lnbDepthItem.removeClass('active');
        }
    });

    $window.on('screen:wide.menu screen:web.menu', function(event) {
        refreshLnbHeight();

        if($lnbSpy.length) {
            $html.removeClass('lnb_open');
            $lnbSpy.parents('.depth_item').removeClass('active');
        }
    });

    $window.on('screen:tablet.menu screen:phone.menu', function(event) {
        refreshLnbHeight();

        if($lnbSpy.length) {
            $html.addClass('lnb_open');
            $lnbSpy.parents('.depth_item').addClass('active');
        }
    });

    //사이드
    var container = {},
        $container = $('#container'),
        side = container.side = {},
        $side = side.$element = $container.find('.side'),
        $sideDepthItem = side.$depthItem = $side.find('.depth_item'),
        $sideSpy = side.$spy = $side.find('.spy:last');

    $sideDepthItem.on('click.menu', function(event) {
        var $this = $(this),
            $depthText = $this.children('.depth_text'),
            eventTarget = event.target;

        if($depthText.find(eventTarget).length || $depthText[0] === eventTarget) {
            if($this.hasClass('depth1_item')) {
                if($this.hasClass('active')) {
                    $html.removeClass('side_open');
                }else{
                    $html.addClass('side_open');
                }
            }

            if($this.children('.depth').length) {
                $this.toggleClass('active').siblings('.depth_item').removeClass('active');
                event.preventDefault();
            }
        }

        event.stopPropagation();
    }).each(function(index, element) {
        var $element = $(element);

        if($element.children('.depth').length) {
            $element.addClass('has');
        }else{
            $element.addClass('solo');
        }
    });

    if($sideSpy.length) {
        $html.addClass('side_open');
        $sideSpy.parents('.depth_item').addClass('active');
    }

    //경로
    var path = header.path = {},
        $path = path.$element = $header.find('.path'),
        $pathDepthItem = path.$depthItem = $path.find('.depth_item');

    $pathDepthItem.on('click.menu', function(event) {
        var $this = $(this),
            $depthText = $this.children('.depth_text'),
            eventTarget = event.target;

        if($depthText.find(eventTarget).length || $depthText[0] === eventTarget) {
            if($this.hasClass('depth1_item')) {
                if($this.hasClass('active')) {
                    $html.removeClass('path_open');
                }else{
                    $html.addClass('path_open');
                }
            }

            if($this.children('.depth').length) {
                $this.toggleClass('active').siblings('.depth_item').removeClass('active');
                event.preventDefault();
            }
        }

        event.stopPropagation();
    }).each(function(index, element) {
        var $element = $(element);

        if($element.children('.depth').length) {
            $element.addClass('has');
        }else{
            $element.addClass('solo');
        }
    });

    //사이드
    var $container = $('#container'),
        $side = $container.find('.side'),
        $sideDepthItem = $side.find('.depth_item'),
        $sideMenu = $side.find('.menu').addClass('init'),
        $sideSpy = $sideMenu.find('.spy:last');

    $sideDepthItem.on('click.menu', function(event) {
        var $this = $(this),
            $depthText = $this.children('.depth_text'),
            eventTarget = event.target;

        if($depthText.find(eventTarget).length || $depthText[0] === eventTarget) {
            if($this.hasClass('depth1_item')) {
                if($this.hasClass('active')) {
                    $html.removeClass('side_open');
                }else{
                    $html.addClass('side_open');
                }
            }

            if($this.children('.depth').length) {
                $this.toggleClass('active').siblings('.depth_item').removeClass('active');
                event.preventDefault();
            }
        }

        event.stopPropagation();
    }).each(function(index, element) {
        var $element = $(element);

        if($element.children('.depth').length) {
            $element.addClass('has');
        }
    });

    if($sideSpy.length) {
        $html.addClass('side_open');
        $sideSpy.parents('.depth_item').addClass('active');
    }
});